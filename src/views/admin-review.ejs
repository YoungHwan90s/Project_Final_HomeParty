<!-- <div id="allUser"></div> -->
<main class="admin-wrap-main">
    <div class="responsive-wrapper">
        <div class="admin-1-header">
            <h1>Reviews Page</h1>
        </div>
        <p class="mb-4">
            이 페이지는 리뷰 관리하는 페이지이므로 부적절한 리뷰 또는 위험적인 리뷰 적발시 삭제
            해주세요.
        </p>
        <div class="horizontal-tabs">
            <a href="/admin-user">User</a>
            <a href="/admin-party">Party</a>
            <a href="/admin-review">Review</a>
            <a href="/admin-tag">Tags</a>
        </div>
    </div>
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Reviews DataTables</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th>Num</th>
                            <th>Name(자세히 보기)</th>
                            <th>Rating</th>
                            <th>Content</th>
                            <th>Party</th>
                            <th>Create</th>
                            <th>Update</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>Num</th>
                            <th>Name</th>
                            <th>Rating</th>
                            <th>Content</th>
                            <th>Party</th>
                            <th>Create</th>
                            <th>Update</th>
                            <th>Delete</th>
                        </tr>
                    </tfoot>
                    <tbody id="reviewTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>
<script>
    $.ajax({
        type: 'GET',
        url: `/admin/review`,
        data: {},
        headers: {
            authorization: `Bearer ${sessionStorage.getItem('accessToken')}`,
            refreshtoken: `${sessionStorage.getItem('refreshToken')}`,
        },
        success: function (response) {
            let count = 0;
            for (let i = 0; i < response.length; i++) {
                const {
                    id: reviewId,
                    userId,
                    partyId,
                    party,
                    user,
                    rating,
                    review,
                    createdAt,
                    updatedAt,
                    deletedAt,
                } = response[i];
                let name = response[i].user.name;

                if (deletedAt === null) {
                    const createdate = new Date();
                    const year = createdate.getFullYear();
                    const month = ('0' + (createdate.getMonth() + 1)).slice(-2);
                    const day = ('0' + createdate.getDate()).slice(-2);

                    const update = new Date();
                    const updateYear = update.getFullYear();
                    const updateMonth = ('0' + (update.getMonth() + 1)).slice(-2);
                    const updateDay = ('0' + update.getDate()).slice(-2);

                    const reviewTable = `<tr>
                            <td>${count + 1}</td>
                            <td><a href="/user-detail/${userId}">${name}</a></td>
                            <td>${rating}</td>
                            <td>${review}</td>
                            <td><a href="/party/${partyId}">파티확인하기</a></td>
                            <td>${year}-${month}-${day}</td>
                            <td>${updateYear}-${updateMonth}-${updateDay}</td>
                            <td><button type="button" onclick="deleteReviewByAdmin(${reviewId})" class="btn btn-danger">Delete</button></td>
                        </tr>`;

                    $('#reviewTable').append(reviewTable);
                    count++;
                }
            }
        },
    });

    function deleteReviewByAdmin(reviewId) {
        const result = confirm('해당 리뷰를 삭제하시겠습니까?');
        if (result) {
            $.ajax({
                type: 'DELETE',
                url: `/admin/review/${reviewId}`,
                data: {},
                headers: {
                    authorization: `Bearer ${sessionStorage.getItem('accessToken')}`,
                    refreshtoken: `${sessionStorage.getItem('refreshToken')}`,
                },
                success: function (response) {
                    alert('리뷰 삭제');
                    $(`#id${reviewId}`).remove();
                    window.location.reload();
                },
            });
        } else {
            alert('삭제 취소');
        }
    }
</script>
